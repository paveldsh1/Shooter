<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>CS 1.0</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            background: black;
            color: #00ff00;
            font-family: Consolas, "Cascadia Mono", monospace;
        }

        #overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        #form {
            background: #111;
            color: #00ff00;
            border: 1px solid #0f0;
            padding: 16px;
            width: 300px;
        }

        #form input[type="text"] {
            width: 100%;
            padding: 8px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        #form button {
            width: 100%;
            padding: 8px;
            background: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
        }

        textarea {
            width: 100vw;
            height: 100vh;
            line-height: 1;
            background: black;
            color: #00ff00;
            border: none;
            outline: none;
            resize: none;
            overflow: hidden;
            font-family: inherit;
            font-size: 14px;
            display: block;
        }

        input {
            width: 100%;
            background: black;
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div id="form">
            <div style="margin-bottom:8px;">Введите никнейм</div>
            <input id="nickname" type="text" maxlength="24" placeholder="Player1" />
            <div id="error" style="color:#f55; min-height:20px;"></div>
            <button id="join">Войти</button>
        </div>
    </div>

    <textarea id="output" readonly rows="40" cols="120" wrap="off" spellcheck="false"></textarea>

    <script>
        const output = document.getElementById("output");
        const overlay = document.getElementById("overlay");
        const joinBtn = document.getElementById("join");
        const nicknameInput = document.getElementById("nickname");
        const errorBox = document.getElementById("error");

        let ws = null;
        let lastCols = 0;
        let lastRows = 0;
        let scale = 1;
        const baseFontSize = 14;
        const measure = document.createElement("span");
        measure.textContent = "W";
        measure.style.position = "absolute";
        measure.style.visibility = "hidden";
        measure.style.whiteSpace = "pre";
        document.body.appendChild(measure);

        function applyScale() {
            output.style.fontSize = `${Math.round(baseFontSize * scale)}px`;
            scheduleResize();
        }

        function getCharSize() {
            const style = getComputedStyle(output);
            measure.style.fontFamily = style.fontFamily;
            measure.style.fontSize = style.fontSize;
            measure.style.lineHeight = style.lineHeight;
            const rect = measure.getBoundingClientRect();
            return { w: rect.width || 1, h: rect.height || 1 };
        }

        function resizeAndSend() {
            const { w, h } = getCharSize();
            const rect = output.getBoundingClientRect();
            const cols = Math.max(20, Math.floor(rect.width / w));
            const rows = Math.max(10, Math.floor(rect.height / h));
            if (cols === lastCols && rows === lastRows) return;
            lastCols = cols;
            lastRows = rows;
            output.cols = cols;
            output.rows = rows;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(`RESIZE ${cols} ${rows} ${scale.toFixed(2)}`);
            }
        }

        let resizeTimer = null;
        function scheduleResize() {
            if (resizeTimer) clearTimeout(resizeTimer);
            resizeTimer = setTimeout(resizeAndSend, 50);
        }

        window.addEventListener("resize", scheduleResize);

        function connectWebSocket() {
            const protocol = location.protocol === "https:" ? "wss://" : "ws://";
            const nickname = nicknameInput.value.trim();
            const url = `${protocol}${location.host}/ws?nick=${encodeURIComponent(nickname)}`;
            ws = new WebSocket(url);

            ws.onopen = () => {
                output.value = "WebSocket connected";
                resizeAndSend();
            };

            ws.onmessage = async e => {
                if (e.data instanceof Blob) {
                    output.value = await e.data.text();
                } else {
                    output.value = e.data;
                }
            };

            ws.onerror = e => {
                output.value = "WebSocket error";
            };

            document.addEventListener("keydown", e => {
                if (overlay.style.display !== "none") return;
                if (e.code === "BracketLeft") {
                    scale = Math.max(0.5, scale - 0.1);
                    applyScale();
                    return;
                }
                if (e.code === "BracketRight") {
                    scale = Math.min(3, scale + 0.1);
                    applyScale();
                    return;
                }
                if (e.code === "Digit0") {
                    scale = 1;
                    applyScale();
                    return;
                }
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(e.code);
                }
            });
        }

        async function registerNickname(nickname) {
            const res = await fetch("/players/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nickname })
            });
            if (res.ok) {
                const data = await res.json();
                return { ok: true };
            }
            return { ok: false, status: res.status, data: await res.json().catch(() => ({})) };
        }

        async function loginNickname(nickname) {
            const res = await fetch("/players/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nickname })
            });
            if (res.ok) {
                return { ok: true };
            }
            return { ok: false, status: res.status, data: await res.json().catch(() => ({})) };
        }

        joinBtn.addEventListener("click", async () => {
            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                errorBox.textContent = "Введите никнейм";
                return;
            }
            try {
                const reg = await registerNickname(nickname);
                if (reg.ok) {
                    //localStorage.setItem("nickname", nickname);
                    //localStorage.setItem("playerId", reg.playerId);
                    overlay.style.display = "none";
                    applyScale();
                    connectWebSocket();
                    return;
                }
                if (reg.status === 409) {
                    const lg = await loginNickname(nickname);
                    if (lg.ok) {
                        //localStorage.setItem("nickname", nickname);
                        //localStorage.setItem("playerId", lg.playerId);
                        overlay.style.display = "none";
                        applyScale();
                        connectWebSocket();
                        return;
                    }
                }
                throw new Error(reg.data?.error || "Registration failed");
            } catch (err) {
                errorBox.textContent = err.message;
            }
        });

        // Авто-логин, если ник уже сохранён
        //const cached = localStorage.getItem("nickname");
        //if (cached) {
        //    overlay.style.display = "none";
        //    connectWebSocket();
        //}
    </script>
</body>
</html>