<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>CS 1.0</title>
    <style>
        body {
            background: black;
            color: #00ff00;
            font-family: Consolas, "Cascadia Mono", monospace;
        }

        #overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        #form {
            background: #111;
            color: #00ff00;
            border: 1px solid #0f0;
            padding: 16px;
            width: 300px;
        }

        #form input[type="text"] {
            width: 100%;
            padding: 8px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        #form button {
            width: 100%;
            padding: 8px;
            background: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
        }

        textarea {
            width: 120ch; /* 120 columns */
            height: calc(40 * 1em); /* 40 rows */
            line-height: 1em;
            background: black;
            color: #00ff00;
            border: none;
            outline: none;
            resize: none;
            overflow: hidden;
            font-family: inherit;
            font-size: 14px;
        }

        input {
            width: 100%;
            background: black;
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div id="form">
            <div style="margin-bottom:8px;">Введите никнейм</div>
            <input id="nickname" type="text" maxlength="24" placeholder="Player1" />
            <div id="error" style="color:#f55; min-height:20px;"></div>
            <button id="join">Войти</button>
        </div>
    </div>

    <textarea id="output" readonly rows="40" cols="120" wrap="off" spellcheck="false"></textarea><br />

    <script>
        const output = document.getElementById("output");
        const overlay = document.getElementById("overlay");
        const joinBtn = document.getElementById("join");
        const nicknameInput = document.getElementById("nickname");
        const errorBox = document.getElementById("error");

        function connectWebSocket() {
            const protocol = location.protocol === "https:" ? "wss://" : "ws://";
            const ws = new WebSocket(protocol + location.host + "/ws");

            ws.onopen = () => {
                output.value = "WebSocket connected";
            };

            ws.onmessage = e => {
                output.value = e.data;
            };

            ws.onerror = e => {
                output.value = "WebSocket error";
            };

            document.addEventListener("keydown", e => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(e.code);
                }
            });
        }

        async function registerNickname(nickname) {
            const res = await fetch("/players/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nickname })
            });
            if (res.ok) {
                const data = await res.json();
                return { ok: true, playerId: data.playerId };
            }
            return { ok: false, status: res.status, data: await res.json().catch(() => ({})) };
        }

        async function loginNickname(nickname) {
            const res = await fetch("/players/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nickname })
            });
            if (res.ok) {
                const data = await res.json();
                return { ok: true, playerId: data.playerId };
            }
            return { ok: false, status: res.status, data: await res.json().catch(() => ({})) };
        }

        joinBtn.addEventListener("click", async () => {
            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                errorBox.textContent = "Введите никнейм";
                return;
            }
            try {
                const reg = await registerNickname(nickname);
                if (reg.ok) {
                    //localStorage.setItem("nickname", nickname);
                    //localStorage.setItem("playerId", reg.playerId);
                    overlay.style.display = "none";
                    connectWebSocket();
                    return;
                }
                if (reg.status === 409) {
                    const lg = await loginNickname(nickname);
                    if (lg.ok) {
                        //localStorage.setItem("nickname", nickname);
                        //localStorage.setItem("playerId", lg.playerId);
                        overlay.style.display = "none";
                        connectWebSocket();
                        return;
                    }
                }
                throw new Error(reg.data?.error || "Registration failed");
            } catch (err) {
                errorBox.textContent = err.message;
            }
        });

        // Авто-логин, если ник уже сохранён
        //const cached = localStorage.getItem("nickname");
        //if (cached) {
        //    overlay.style.display = "none";
        //    connectWebSocket();
        //}
    </script>
</body>
</html>